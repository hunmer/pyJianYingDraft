<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰ªªÂä°Áä∂ÊÄÅ - Ââ™Êò†ËçâÁ®øÁîüÊàê</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 40px;
        }

        .task-info {
            margin-bottom: 30px;
        }

        .info-item {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #666;
            width: 120px;
            flex-shrink: 0;
        }

        .info-value {
            color: #333;
            flex: 1;
            word-break: break-all;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-downloading {
            background: #cce5ff;
            color: #004085;
        }

        .status-processing {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .status-cancelled {
            background: #e2e3e5;
            color: #383d41;
        }

        .progress-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .progress-bar-container {
            background: #e9ecef;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 13px;
        }

        .progress-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .progress-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .progress-item-value {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .progress-item-label {
            font-size: 12px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .draft-path {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 13px;
            word-break: break-all;
        }

        .footer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            color: #666;
            font-size: 13px;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .refresh-icon {
            animation: spin 2s linear infinite;
        }

        .timestamp {
            font-size: 12px;
            color: #999;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .copy-btn {
            padding: 8px 16px;
            font-size: 13px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #155724;
            color: white;
            padding: 15px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìπ Ââ™Êò†ËçâÁ®øÁîüÊàê‰ªªÂä°</h1>
            <p>ÂÆûÊó∂ÁõëÊéß‰ªªÂä°Áä∂ÊÄÅÂíåËøõÂ∫¶</p>
        </div>

        <div class="content">
            <div class="auto-refresh" id="autoRefreshIndicator">
                <span class="refresh-icon">üîÑ</span>
                <span>Ëá™Âä®Âà∑Êñ∞‰∏≠...</span>
                <span class="timestamp" id="lastUpdate"></span>
            </div>

            <div class="task-info">
                <div class="info-item">
                    <div class="info-label">‰ªªÂä° ID:</div>
                    <div class="info-value" id="taskId">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Áä∂ÊÄÅ:</div>
                    <div class="info-value">
                        <span class="status-badge" id="taskStatus">-</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">Ê∂àÊÅØ:</div>
                    <div class="info-value" id="taskMessage">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">ÂàõÂª∫Êó∂Èó¥:</div>
                    <div class="info-value" id="createdAt">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Êõ¥Êñ∞Êó∂Èó¥:</div>
                    <div class="info-value" id="updatedAt">-</div>
                </div>
            </div>

            <div id="progressSection" class="progress-section" style="display: none;">
                <h3 style="margin-bottom: 15px; color: #333;">‰∏ãËΩΩËøõÂ∫¶</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
                </div>
                <div class="progress-details" id="progressDetails"></div>
            </div>

            <div id="errorMessage" class="error-message" style="display: none;"></div>
            <div id="successMessage" class="success-message" style="display: none;"></div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="refreshBtn" onclick="refreshStatus()">üîÑ Á´ãÂç≥Âà∑Êñ∞</button>
                <button class="btn btn-secondary" id="cancelBtn" onclick="cancelTask()" style="display: none;">‚ùå ÂèñÊ∂à‰ªªÂä°</button>
            </div>

            <div class="action-buttons" style="margin-top: 10px;">
                <button class="btn btn-secondary copy-btn" id="copyUrlBtn" onclick="copyJsonUrl()">üìã Â§çÂà∂ JSON URL</button>
                <button class="btn btn-secondary copy-btn" id="copyDataBtn" onclick="copyJsonData()">üìã Â§çÂà∂ JSON Êï∞ÊçÆ</button>
            </div>

            <div id="jsonUrlInfo" style="display: none; margin-top: 15px; padding: 12px; background: #e7f3ff; border-radius: 6px; font-size: 13px;">
                <div style="color: #0066cc; font-weight: 600; margin-bottom: 5px;">üìé JSON URL</div>
                <div id="jsonUrlDisplay" style="word-break: break-all; color: #333; font-family: monospace;"></div>
            </div>
        </div>

        <div class="footer">
            <p>pyJianYingDraft - Ëá™Âä®ÂåñÂâ™Êò†ËçâÁ®øÁîüÊàêÂ∑•ÂÖ∑</p>
        </div>
    </div>

    <script>
        // ‰ªé URL ÂèÇÊï∞Ëé∑Âèñ‰ªªÂä° ID„ÄÅJSON URL ÊàñÂéüÂßã URL
        const urlParams = new URLSearchParams(window.location.search);
        let taskId = urlParams.get('task_id');
        let jsonUrl = urlParams.get('json_url');
        const url = urlParams.get('url'); // Êñ∞Â¢û:ÊîØÊåÅÁõ¥Êé•‰º†ÂÖ• url ÂèÇÊï∞

        let refreshInterval = null;
        let isCompleted = false;
        let isSubmitting = false; // Ê†áËÆ∞ÊòØÂê¶Ê≠£Âú®Êèê‰∫§‰ªªÂä°

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        window.onload = function() {
            // Â¶ÇÊûúÊúâ url ÂèÇÊï∞‰ΩÜÊ≤°Êúâ task_id,ÂàôËá™Âä®Êèê‰∫§‰ªªÂä°
            if (url && !taskId) {
                submitTaskWithUrl(url);
                return;
            }

            // Â¶ÇÊûúÊ≤°Êúâ task_id,ÊòæÁ§∫ÈîôËØØ
            if (!taskId) {
                showError('Êú™Êèê‰æõ‰ªªÂä° ID Êàñ URL');
                return;
            }

            document.getElementById('taskId').textContent = taskId;

            // ÂàùÂßãÂåñ JSON URL Áõ∏ÂÖ≥ UI
            initJsonUrlUI();

            refreshStatus();
            startAutoRefresh();
        };

        // ‰ΩøÁî® URL Êèê‰∫§‰ªªÂä°
        async function submitTaskWithUrl(url) {
            if (isSubmitting) return;
            isSubmitting = true;

            try {
                // ÊòæÁ§∫Êèê‰∫§‰∏≠Áä∂ÊÄÅ
                document.getElementById('taskId').textContent = 'Ê≠£Âú®Êèê‰∫§‰ªªÂä°...';
                document.getElementById('taskStatus').textContent = 'Êèê‰∫§‰∏≠';
                document.getElementById('taskStatus').className = 'status-badge status-pending';
                document.getElementById('taskMessage').innerHTML = 'Ê≠£Âú®ÈÄöËøá URL Êèê‰∫§‰ªªÂä°,ËØ∑Á®çÂÄô...<span class="spinner"></span>';

                // Ë∞ÉÁî®ÂêéÁ´Ø API
                const encodedUrl = encodeURIComponent(url);
                const response = await fetch(`/api/tasks/submit_with_url?url=${encodedUrl}`, {
                    method: 'GET' // ‰ΩøÁî® GET ÊñπÊ≥ï,Âõ†‰∏∫ÂêéÁ´ØÊîØÊåÅ GET
                });

                // Ê£ÄÊü•ÂìçÂ∫îÊòØÂê¶ÈáçÂÆöÂêë
                if (response.redirected) {
                    // Â¶ÇÊûúË¢´ÈáçÂÆöÂêë,Âàô‰ªéÈáçÂÆöÂêëURL‰∏≠ÊèêÂèñtask_idÂíåjson_url
                    const redirectUrl = new URL(response.url);
                    taskId = redirectUrl.searchParams.get('task_id');
                    jsonUrl = redirectUrl.searchParams.get('json_url');

                    if (taskId) {
                        // Êõ¥Êñ∞ URL ‰ΩÜ‰∏çÂà∑Êñ∞È°µÈù¢
                        window.history.replaceState({}, '', redirectUrl.pathname + redirectUrl.search);

                        // ÂàùÂßãÂåñ UI
                        document.getElementById('taskId').textContent = taskId;
                        initJsonUrlUI();

                        // ÂºÄÂßãÊü•ËØ¢‰ªªÂä°Áä∂ÊÄÅ
                        refreshStatus();
                        startAutoRefresh();
                    } else {
                        throw new Error('Êú™ËÉΩËé∑Âèñ‰ªªÂä° ID');
                    }
                } else if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }

            } catch (error) {
                console.error('Êèê‰∫§‰ªªÂä°Â§±Ë¥•:', error);
                showError(`Êèê‰∫§‰ªªÂä°Â§±Ë¥•: ${error.message}`);
            } finally {
                isSubmitting = false;
            }
        }

        // ÂàùÂßãÂåñ JSON URL UI
        function initJsonUrlUI() {
            const copyUrlBtn = document.getElementById('copyUrlBtn');
            const copyDataBtn = document.getElementById('copyDataBtn');
            const jsonUrlInfo = document.getElementById('jsonUrlInfo');
            const jsonUrlDisplay = document.getElementById('jsonUrlDisplay');

            if (jsonUrl) {
                // ÊòæÁ§∫ JSON URL ‰ø°ÊÅØ
                jsonUrlInfo.style.display = 'block';
                jsonUrlDisplay.textContent = jsonUrl;
            } else {
                // Á¶ÅÁî®Â§çÂà∂ÊåâÈíÆ
                copyUrlBtn.disabled = true;
                copyDataBtn.disabled = true;
                copyUrlBtn.title = 'Êú™Êèê‰æõ JSON URL';
                copyDataBtn.title = 'Êú™Êèê‰æõ JSON URL';
            }
        }

        // ÂºÄÂßãËá™Âä®Âà∑Êñ∞
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                if (!isCompleted) {
                    refreshStatus();
                }
            }, 2000); // ÊØè 2 ÁßíÂà∑Êñ∞‰∏ÄÊ¨°
        }

        // ÂÅúÊ≠¢Ëá™Âä®Âà∑Êñ∞
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            document.getElementById('autoRefreshIndicator').style.display = 'none';
        }

        // Âà∑Êñ∞‰ªªÂä°Áä∂ÊÄÅ
        async function refreshStatus() {
            try {
                const response = await fetch(`/api/tasks/${taskId}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                updateUI(data);
                updateLastUpdateTime();

            } catch (error) {
                console.error('Âà∑Êñ∞Â§±Ë¥•:', error);
                showError(`Âà∑Êñ∞Â§±Ë¥•: ${error.message}`);
            }
        }

        // Êõ¥Êñ∞ UI
        function updateUI(data) {
            // Êõ¥Êñ∞Âü∫Êú¨‰ø°ÊÅØ
            updateStatus(data.status, data.message);
            document.getElementById('createdAt').textContent = formatTime(data.created_at);
            document.getElementById('updatedAt').textContent = formatTime(data.updated_at);

            // Êõ¥Êñ∞ JSON URL (Â¶ÇÊûúAPIËøîÂõû‰∫Ü)
            if (data.json_url && !jsonUrl) {
                jsonUrl = data.json_url;
                initJsonUrlUI();
            }

            // ÊòæÁ§∫/ÈöêËóèÂèñÊ∂àÊåâÈíÆ
            const cancelBtn = document.getElementById('cancelBtn');
            if (data.status === 'pending' || data.status === 'downloading') {
                cancelBtn.style.display = 'block';
            } else {
                cancelBtn.style.display = 'none';
            }

            // Êõ¥Êñ∞ËøõÂ∫¶‰ø°ÊÅØ
            if (data.progress && data.status === 'downloading') {
                updateProgress(data.progress);
            } else {
                document.getElementById('progressSection').style.display = 'none';
            }

            // Â§ÑÁêÜÂÆåÊàêÁä∂ÊÄÅ
            if (data.status === 'completed') {
                isCompleted = true;
                stopAutoRefresh();
                showSuccess(data.draft_path);
            }

            // Â§ÑÁêÜÂ§±Ë¥•Áä∂ÊÄÅ
            if (data.status === 'failed') {
                isCompleted = true;
                stopAutoRefresh();
                showError(data.error_message || '‰ªªÂä°Â§±Ë¥•');
            }

            // Â§ÑÁêÜÂèñÊ∂àÁä∂ÊÄÅ
            if (data.status === 'cancelled') {
                isCompleted = true;
                stopAutoRefresh();
                showError('‰ªªÂä°Â∑≤ÂèñÊ∂à');
            }
        }

        // Êõ¥Êñ∞Áä∂ÊÄÅÊòæÁ§∫
        function updateStatus(status, message) {
            const statusBadge = document.getElementById('taskStatus');
            const messageEl = document.getElementById('taskMessage');

            statusBadge.textContent = getStatusText(status);
            statusBadge.className = 'status-badge status-' + status;

            messageEl.textContent = message;

            // Ê∑ªÂä†Âä†ËΩΩÂä®Áîª
            if (['pending', 'downloading', 'processing'].includes(status)) {
                if (!messageEl.querySelector('.spinner')) {
                    const spinner = document.createElement('span');
                    spinner.className = 'spinner';
                    messageEl.appendChild(spinner);
                }
            }
        }

        // Ëé∑ÂèñÁä∂ÊÄÅÊñáÊú¨
        function getStatusText(status) {
            const statusMap = {
                'pending': 'Á≠âÂæÖ‰∏≠',
                'downloading': '‰∏ãËΩΩ‰∏≠',
                'processing': 'Â§ÑÁêÜ‰∏≠',
                'completed': 'Â∑≤ÂÆåÊàê',
                'failed': 'Â§±Ë¥•',
                'cancelled': 'Â∑≤ÂèñÊ∂à'
            };
            return statusMap[status] || status;
        }

        // Êõ¥Êñ∞ËøõÂ∫¶ÊòæÁ§∫
        function updateProgress(progress) {
            const section = document.getElementById('progressSection');
            section.style.display = 'block';

            const percent = progress.progress_percent || 0;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent.toFixed(1) + '%';

            // Êõ¥Êñ∞ËøõÂ∫¶ËØ¶ÊÉÖ
            const detailsHTML = `
                <div class="progress-item">
                    <div class="progress-item-value">${progress.completed_files || 0}/${progress.total_files || 0}</div>
                    <div class="progress-item-label">Â∑≤ÂÆåÊàê/ÊÄªÊñá‰ª∂</div>
                </div>
                <div class="progress-item">
                    <div class="progress-item-value">${formatBytes(progress.downloaded_size || 0)}</div>
                    <div class="progress-item-label">Â∑≤‰∏ãËΩΩ</div>
                </div>
                <div class="progress-item">
                    <div class="progress-item-value">${formatBytes(progress.download_speed || 0)}/s</div>
                    <div class="progress-item-label">‰∏ãËΩΩÈÄüÂ∫¶</div>
                </div>
                <div class="progress-item">
                    <div class="progress-item-value">${formatSeconds(progress.eta_seconds)}</div>
                    <div class="progress-item-label">È¢ÑËÆ°Ââ©‰Ωô</div>
                </div>
            `;
            document.getElementById('progressDetails').innerHTML = detailsHTML;
        }

        // ÊòæÁ§∫ÈîôËØØÊ∂àÊÅØ
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }

        // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
        function showSuccess(draftPath) {
            const successDiv = document.getElementById('successMessage');
            successDiv.innerHTML = `
                <strong>‚úÖ ËçâÁ®øÁîüÊàêÊàêÂäüÔºÅ</strong>
                <div class="draft-path">üìÅ ${draftPath || '(Ë∑ØÂæÑÊú™Êèê‰æõ)'}</div>
            `;
            successDiv.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        // ÂèñÊ∂à‰ªªÂä°
        async function cancelTask() {
            if (!confirm('Á°ÆÂÆöË¶ÅÂèñÊ∂àËøô‰∏™‰ªªÂä°ÂêóÔºü')) {
                return;
            }

            try {
                const response = await fetch(`/api/tasks/${taskId}/cancel`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    alert('‰ªªÂä°Â∑≤ÂèñÊ∂à');
                    refreshStatus();
                } else {
                    alert('ÂèñÊ∂àÂ§±Ë¥•: ' + data.message);
                }
            } catch (error) {
                alert('ÂèñÊ∂àÂ§±Ë¥•: ' + error.message);
            }
        }

        // Êõ¥Êñ∞ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent =
                'ÊúÄÂêéÊõ¥Êñ∞: ' + now.toLocaleTimeString('zh-CN');
        }

        // Ê†ºÂºèÂåñÊó∂Èó¥
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // Ê†ºÂºèÂåñÂ≠óËäÇÂ§ßÂ∞è
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        }

        // Ê†ºÂºèÂåñÁßíÊï∞
        function formatSeconds(seconds) {
            if (!seconds || seconds < 0) return '-';
            if (seconds < 60) return seconds.toFixed(0) + 'Áßí';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'ÂàÜÈíü';
            return Math.floor(seconds / 3600) + 'Â∞èÊó∂';
        }

        // Â§çÂà∂ JSON URL (Êù•Ëá™ URL ÂèÇÊï∞ÁöÑÂéüÂßã JSON URL)
        function copyJsonUrl() {
            if (!jsonUrl) {
                showToast('Êú™ÊâæÂà∞ JSON URL', 'error');
                return;
            }
            copyToClipboard(jsonUrl, 'JSON URL Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
        }

        // Â§çÂà∂ JSON Êï∞ÊçÆ (‰ªéÂéüÂßã JSON URL Ëé∑ÂèñÊï∞ÊçÆ)
        async function copyJsonData() {
            if (!jsonUrl) {
                showToast('Êú™ÊâæÂà∞ JSON URL', 'error');
                return;
            }

            try {
                const response = await fetch(jsonUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                const jsonString = JSON.stringify(data, null, 2);
                copyToClipboard(jsonString, 'JSON Êï∞ÊçÆÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
            } catch (error) {
                showToast('Â§çÂà∂Â§±Ë¥•: ' + error.message, 'error');
            }
        }

        // Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÁöÑÈÄöÁî®ÂáΩÊï∞
        function copyToClipboard(text, successMessage) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        showToast(successMessage);
                    })
                    .catch(err => {
                        // ÈôçÁ∫ßÂà∞ÊóßÊñπÊ≥ï
                        fallbackCopy(text, successMessage);
                    });
            } else {
                // ÈôçÁ∫ßÂà∞ÊóßÊñπÊ≥ï
                fallbackCopy(text, successMessage);
            }
        }

        // ÈôçÁ∫ßÁöÑÂ§çÂà∂ÊñπÊ≥ï(ÂÖºÂÆπÊóßÊµèËßàÂô®)
        function fallbackCopy(text, successMessage) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();

            try {
                document.execCommand('copy');
                showToast(successMessage);
            } catch (err) {
                showToast('Â§çÂà∂Â§±Ë¥•,ËØ∑ÊâãÂä®Â§çÂà∂', 'error');
            } finally {
                document.body.removeChild(textArea);
            }
        }

        // ÊòæÁ§∫ÊèêÁ§∫Ê∂àÊÅØ
        function showToast(message, type = 'success') {
            // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑ toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;

            if (type === 'error') {
                toast.style.background = '#721c24';
            }

            document.body.appendChild(toast);

            // 3 ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 3000);
        }

        // È°µÈù¢Âç∏ËΩΩÊó∂ÂÅúÊ≠¢Âà∑Êñ∞
        window.onbeforeunload = function() {
            stopAutoRefresh();
        };
    </script>
</body>
</html>
