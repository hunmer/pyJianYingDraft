<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»»åŠ¡çŠ¶æ€ - å‰ªæ˜ è‰ç¨¿ç”Ÿæˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 40px;
        }

        .task-info {
            margin-bottom: 30px;
        }

        .info-item {
            display: flex;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 600;
            color: #666;
            width: 120px;
            flex-shrink: 0;
        }

        .info-value {
            color: #333;
            flex: 1;
            word-break: break-all;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-downloading {
            background: #cce5ff;
            color: #004085;
        }

        .status-processing {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-failed {
            background: #f8d7da;
            color: #721c24;
        }

        .status-cancelled {
            background: #e2e3e5;
            color: #383d41;
        }

        .progress-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .progress-bar-container {
            background: #e9ecef;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 13px;
        }

        .progress-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .progress-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 6px;
        }

        .progress-item-value {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .progress-item-label {
            font-size: 12px;
            color: #666;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
            vertical-align: middle;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        .draft-path {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 13px;
            word-break: break-all;
        }

        .footer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            color: #666;
            font-size: 13px;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            background: #e7f3ff;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .refresh-icon {
            animation: spin 2s linear infinite;
        }

        .timestamp {
            font-size: 12px;
            color: #999;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .copy-btn {
            padding: 8px 16px;
            font-size: 13px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #155724;
            color: white;
            padding: 15px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¹ å‰ªæ˜ è‰ç¨¿ç”Ÿæˆä»»åŠ¡</h1>
            <p>å®æ—¶ç›‘æ§ä»»åŠ¡çŠ¶æ€å’Œè¿›åº¦</p>
        </div>

        <div class="content">
            <div class="auto-refresh" id="autoRefreshIndicator">
                <span class="refresh-icon">ğŸ”„</span>
                <span>è‡ªåŠ¨åˆ·æ–°ä¸­...</span>
                <span class="timestamp" id="lastUpdate"></span>
            </div>

            <div class="task-info">
                <div class="info-item">
                    <div class="info-label">ä»»åŠ¡ ID:</div>
                    <div class="info-value" id="taskId">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">çŠ¶æ€:</div>
                    <div class="info-value">
                        <span class="status-badge" id="taskStatus">-</span>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ¶ˆæ¯:</div>
                    <div class="info-value" id="taskMessage">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">åˆ›å»ºæ—¶é—´:</div>
                    <div class="info-value" id="createdAt">-</div>
                </div>
                <div class="info-item">
                    <div class="info-label">æ›´æ–°æ—¶é—´:</div>
                    <div class="info-value" id="updatedAt">-</div>
                </div>
            </div>

            <div id="progressSection" class="progress-section" style="display: none;">
                <h3 style="margin-bottom: 15px; color: #333;">ä¸‹è½½è¿›åº¦</h3>
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
                </div>
                <div class="progress-details" id="progressDetails"></div>
            </div>

            <div id="errorMessage" class="error-message" style="display: none;"></div>
            <div id="successMessage" class="success-message" style="display: none;"></div>

            <div class="action-buttons">
                <button class="btn btn-primary" id="refreshBtn" onclick="refreshStatus()">ğŸ”„ ç«‹å³åˆ·æ–°</button>
                <button class="btn btn-secondary" id="cancelBtn" onclick="cancelTask()" style="display: none;">âŒ å–æ¶ˆä»»åŠ¡</button>
            </div>

            <div class="action-buttons" style="margin-top: 10px;">
                <button class="btn btn-secondary copy-btn" id="copyUrlBtn" onclick="copyJsonUrl()">ğŸ“‹ å¤åˆ¶ JSON URL</button>
                <button class="btn btn-secondary copy-btn" id="copyDataBtn" onclick="copyJsonData()">ğŸ“‹ å¤åˆ¶ JSON æ•°æ®</button>
            </div>

            <div id="jsonUrlInfo" style="display: none; margin-top: 15px; padding: 12px; background: #e7f3ff; border-radius: 6px; font-size: 13px;">
                <div style="color: #0066cc; font-weight: 600; margin-bottom: 5px;">ğŸ“ JSON URL</div>
                <div id="jsonUrlDisplay" style="word-break: break-all; color: #333; font-family: monospace;"></div>
            </div>
        </div>

        <div class="footer">
            <p>pyJianYingDraft - è‡ªåŠ¨åŒ–å‰ªæ˜ è‰ç¨¿ç”Ÿæˆå·¥å…·</p>
        </div>
    </div>

    <script>
        // ä» URL å‚æ•°è·å–ä»»åŠ¡ IDã€JSON URL æˆ–åŸå§‹ URL
        const urlParams = new URLSearchParams(window.location.search);
        let taskId = urlParams.get('task_id');
        let jsonUrl = urlParams.get('json_url');
        const url = urlParams.get('url'); // æ–°å¢:æ”¯æŒç›´æ¥ä¼ å…¥ url å‚æ•°

        let refreshInterval = null;
        let isCompleted = false;
        let isSubmitting = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨æäº¤ä»»åŠ¡

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            // å¦‚æœæœ‰ url å‚æ•°ä½†æ²¡æœ‰ task_id,åˆ™è‡ªåŠ¨æäº¤ä»»åŠ¡
            if (url && !taskId) {
                submitTaskWithUrl(url);
                return;
            }

            // å¦‚æœæ²¡æœ‰ task_id,æ˜¾ç¤ºé”™è¯¯
            if (!taskId) {
                showError('æœªæä¾›ä»»åŠ¡ ID æˆ– URL');
                return;
            }

            document.getElementById('taskId').textContent = taskId;

            // åˆå§‹åŒ– JSON URL ç›¸å…³ UI
            initJsonUrlUI();

            refreshStatus();
            startAutoRefresh();
        };

        // ä½¿ç”¨ URL æäº¤ä»»åŠ¡
        async function submitTaskWithUrl(url) {
            if (isSubmitting) return;
            isSubmitting = true;

            try {
                // æ˜¾ç¤ºæäº¤ä¸­çŠ¶æ€
                document.getElementById('taskId').textContent = 'æ­£åœ¨æäº¤ä»»åŠ¡...';
                document.getElementById('taskStatus').textContent = 'æäº¤ä¸­';
                document.getElementById('taskStatus').className = 'status-badge status-pending';
                document.getElementById('taskMessage').innerHTML = 'æ­£åœ¨é€šè¿‡ URL æäº¤ä»»åŠ¡,è¯·ç¨å€™...<span class="spinner"></span>';

                // è°ƒç”¨åç«¯ API
                const encodedUrl = encodeURIComponent(url);
                const response = await fetch(`/api/tasks/submit_with_url?url=${encodedUrl}`, {
                    method: 'GET' // ä½¿ç”¨ GET æ–¹æ³•,å› ä¸ºåç«¯æ”¯æŒ GET
                });

                // æ£€æŸ¥å“åº”æ˜¯å¦é‡å®šå‘
                if (response.redirected) {
                    // å¦‚æœè¢«é‡å®šå‘,åˆ™ä»é‡å®šå‘URLä¸­æå–task_idå’Œjson_url
                    const redirectUrl = new URL(response.url);
                    taskId = redirectUrl.searchParams.get('task_id');
                    jsonUrl = redirectUrl.searchParams.get('json_url');

                    if (taskId) {
                        // æ›´æ–° URL ä½†ä¸åˆ·æ–°é¡µé¢
                        window.history.replaceState({}, '', redirectUrl.pathname + redirectUrl.search);

                        // åˆå§‹åŒ– UI
                        document.getElementById('taskId').textContent = taskId;
                        initJsonUrlUI();

                        // å¼€å§‹æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
                        refreshStatus();
                        startAutoRefresh();
                    } else {
                        throw new Error('æœªèƒ½è·å–ä»»åŠ¡ ID');
                    }
                } else if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP ${response.status}`);
                }

            } catch (error) {
                console.error('æäº¤ä»»åŠ¡å¤±è´¥:', error);
                showError(`æäº¤ä»»åŠ¡å¤±è´¥: ${error.message}`);
            } finally {
                isSubmitting = false;
            }
        }

        // åˆå§‹åŒ– JSON URL UI
        function initJsonUrlUI() {
            const copyUrlBtn = document.getElementById('copyUrlBtn');
            const copyDataBtn = document.getElementById('copyDataBtn');
            const jsonUrlInfo = document.getElementById('jsonUrlInfo');
            const jsonUrlDisplay = document.getElementById('jsonUrlDisplay');

            if (jsonUrl) {
                // æ˜¾ç¤º JSON URL ä¿¡æ¯
                jsonUrlInfo.style.display = 'block';
                jsonUrlDisplay.textContent = jsonUrl;
            } else {
                // ç¦ç”¨å¤åˆ¶æŒ‰é’®
                copyUrlBtn.disabled = true;
                copyDataBtn.disabled = true;
                copyUrlBtn.title = 'æœªæä¾› JSON URL';
                copyDataBtn.title = 'æœªæä¾› JSON URL';
            }
        }

        // å¼€å§‹è‡ªåŠ¨åˆ·æ–°
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                if (!isCompleted) {
                    refreshStatus();
                }
            }, 2000); // æ¯ 2 ç§’åˆ·æ–°ä¸€æ¬¡
        }

        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
            document.getElementById('autoRefreshIndicator').style.display = 'none';
        }

        // åˆ·æ–°ä»»åŠ¡çŠ¶æ€
        async function refreshStatus() {
            try {
                const response = await fetch(`/api/tasks/${taskId}`);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                updateUI(data);
                updateLastUpdateTime();

            } catch (error) {
                console.error('åˆ·æ–°å¤±è´¥:', error);
                showError(`åˆ·æ–°å¤±è´¥: ${error.message}`);
            }
        }

        // æ›´æ–° UI
        function updateUI(data) {
            // æ›´æ–°åŸºæœ¬ä¿¡æ¯
            updateStatus(data.status, data.message);
            document.getElementById('createdAt').textContent = formatTime(data.created_at);
            document.getElementById('updatedAt').textContent = formatTime(data.updated_at);

            // æ›´æ–° JSON URL (å¦‚æœAPIè¿”å›äº†)
            if (data.json_url && !jsonUrl) {
                jsonUrl = data.json_url;
                initJsonUrlUI();
            }

            // æ˜¾ç¤º/éšè—å–æ¶ˆæŒ‰é’®
            const cancelBtn = document.getElementById('cancelBtn');
            if (data.status === 'pending' || data.status === 'downloading') {
                cancelBtn.style.display = 'block';
            } else {
                cancelBtn.style.display = 'none';
            }

            // æ›´æ–°è¿›åº¦ä¿¡æ¯
            if (data.progress && data.status === 'downloading') {
                updateProgress(data.progress);
            } else {
                document.getElementById('progressSection').style.display = 'none';
            }

            // å¤„ç†å®ŒæˆçŠ¶æ€
            if (data.status === 'completed') {
                isCompleted = true;
                stopAutoRefresh();
                showSuccess(data.draft_path);
            }

            // å¤„ç†å¤±è´¥çŠ¶æ€
            if (data.status === 'failed') {
                isCompleted = true;
                stopAutoRefresh();
                showError(data.error_message || 'ä»»åŠ¡å¤±è´¥');
            }

            // å¤„ç†å–æ¶ˆçŠ¶æ€
            if (data.status === 'cancelled') {
                isCompleted = true;
                stopAutoRefresh();
                showError('ä»»åŠ¡å·²å–æ¶ˆ');
            }
        }

        // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
        function updateStatus(status, message) {
            const statusBadge = document.getElementById('taskStatus');
            const messageEl = document.getElementById('taskMessage');

            statusBadge.textContent = getStatusText(status);
            statusBadge.className = 'status-badge status-' + status;

            messageEl.textContent = message;

            // æ·»åŠ åŠ è½½åŠ¨ç”»
            if (['pending', 'downloading', 'processing'].includes(status)) {
                if (!messageEl.querySelector('.spinner')) {
                    const spinner = document.createElement('span');
                    spinner.className = 'spinner';
                    messageEl.appendChild(spinner);
                }
            }
        }

        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ç­‰å¾…ä¸­',
                'downloading': 'ä¸‹è½½ä¸­',
                'processing': 'å¤„ç†ä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }

        // æ›´æ–°è¿›åº¦æ˜¾ç¤º
        function updateProgress(progress) {
            const section = document.getElementById('progressSection');
            section.style.display = 'block';

            const percent = progress.progress_percent || 0;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent.toFixed(1) + '%';

            // æ›´æ–°è¿›åº¦è¯¦æƒ…
            const detailsHTML = `
                <div class="progress-item">
                    <div class="progress-item-value">${progress.completed_files || 0}/${progress.total_files || 0}</div>
                    <div class="progress-item-label">å·²å®Œæˆ/æ€»æ–‡ä»¶</div>
                </div>
                <div class="progress-item">
                    <div class="progress-item-value">${formatBytes(progress.downloaded_size || 0)}</div>
                    <div class="progress-item-label">å·²ä¸‹è½½</div>
                </div>
                <div class="progress-item">
                    <div class="progress-item-value">${formatBytes(progress.download_speed || 0)}/s</div>
                    <div class="progress-item-label">ä¸‹è½½é€Ÿåº¦</div>
                </div>
                <div class="progress-item">
                    <div class="progress-item-value">${formatSeconds(progress.eta_seconds)}</div>
                    <div class="progress-item-label">é¢„è®¡å‰©ä½™</div>
                </div>
            `;
            document.getElementById('progressDetails').innerHTML = detailsHTML;
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = 'âŒ ' + message;
            errorDiv.style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(draftPath) {
            const successDiv = document.getElementById('successMessage');
            successDiv.innerHTML = `
                <strong>âœ… è‰ç¨¿ç”ŸæˆæˆåŠŸï¼</strong>
                <div class="draft-path">ğŸ“ ${draftPath || '(è·¯å¾„æœªæä¾›)'}</div>
            `;
            successDiv.style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
        }

        // å–æ¶ˆä»»åŠ¡
        async function cancelTask() {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/tasks/${taskId}/cancel`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    alert('ä»»åŠ¡å·²å–æ¶ˆ');
                    refreshStatus();
                } else {
                    alert('å–æ¶ˆå¤±è´¥: ' + data.message);
                }
            } catch (error) {
                alert('å–æ¶ˆå¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent =
                'æœ€åæ›´æ–°: ' + now.toLocaleTimeString('zh-CN');
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // æ ¼å¼åŒ–å­—èŠ‚å¤§å°
        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return (bytes / Math.pow(k, i)).toFixed(2) + ' ' + sizes[i];
        }

        // æ ¼å¼åŒ–ç§’æ•°
        function formatSeconds(seconds) {
            if (!seconds || seconds < 0) return '-';
            if (seconds < 60) return seconds.toFixed(0) + 'ç§’';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'åˆ†é’Ÿ';
            return Math.floor(seconds / 3600) + 'å°æ—¶';
        }

        // å¤åˆ¶ JSON URL (æ¥è‡ª URL å‚æ•°çš„åŸå§‹ JSON URL)
        function copyJsonUrl() {
            if (!jsonUrl) {
                showToast('æœªæ‰¾åˆ° JSON URL', 'error');
                return;
            }
            copyToClipboard(jsonUrl, 'JSON URL å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }

        // å¤åˆ¶ JSON æ•°æ® (ä»åŸå§‹ JSON URL è·å–æ•°æ®)
        async function copyJsonData() {
            if (!jsonUrl) {
                showToast('æœªæ‰¾åˆ° JSON URL', 'error');
                return;
            }

            try {
                const response = await fetch(jsonUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const data = await response.json();
                const jsonString = JSON.stringify(data, null, 2);
                copyToClipboard(jsonString, 'JSON æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (error) {
                showToast('å¤åˆ¶å¤±è´¥: ' + error.message, 'error');
            }
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿çš„é€šç”¨å‡½æ•°
        function copyToClipboard(text, successMessage) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        showToast(successMessage);
                    })
                    .catch(err => {
                        // é™çº§åˆ°æ—§æ–¹æ³•
                        fallbackCopy(text, successMessage);
                    });
            } else {
                // é™çº§åˆ°æ—§æ–¹æ³•
                fallbackCopy(text, successMessage);
            }
        }

        // é™çº§çš„å¤åˆ¶æ–¹æ³•(å…¼å®¹æ—§æµè§ˆå™¨)
        function fallbackCopy(text, successMessage) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();

            try {
                document.execCommand('copy');
                showToast(successMessage);
            } catch (err) {
                showToast('å¤åˆ¶å¤±è´¥,è¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            } finally {
                document.body.removeChild(textArea);
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'success') {
            // ç§»é™¤å·²å­˜åœ¨çš„ toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;

            if (type === 'error') {
                toast.style.background = '#721c24';
            }

            document.body.appendChild(toast);

            // 3 ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 3000);
        }

        // é¡µé¢å¸è½½æ—¶åœæ­¢åˆ·æ–°
        window.onbeforeunload = function() {
            stopAutoRefresh();
        };
    </script>
</body>
</html>
