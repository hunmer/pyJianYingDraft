# 新类型添加快速参考

## 快速检查清单

添加新轨道类型 `new_type` 和素材类型 `new_material` 时需要修改的文件:

### ✅ 核心库 (pyJianYingDraft)

#### 1. 创建 Segment 类
**文件**: `pyJianYingDraft/new_segment.py` (新建)
```python
from pyJianYingDraft.segment import BaseSegment

class NewSegment(BaseSegment):
    def export_json(self) -> dict:
        data = super().export_json()
        # 添加自定义字段
        return data
```

#### 2. 添加到 TrackType 枚举
**文件**: `pyJianYingDraft/track.py:31-45`
```python
class TrackType(Enum):
    new_type = Track_meta(NewSegment, render_index, allow_modify)
```

#### 3. 导出到包 (可选)
**文件**: `pyJianYingDraft/__init__.py`
```python
from pyJianYingDraft.new_segment import NewSegment
```

---

### ✅ 服务端 (pyJianYingDraftServer)

**文件**: `pyJianYingDraftServer/app/services/rule_test_service.py`

#### 4. 添加类型常量
**位置**: 第 39-41 行
```python
NEW_TYPES = {"new_material", "new_material_variant"}
```

#### 5. 添加类型推断逻辑
**位置**: `_infer_track_type` 方法 (第 136-149 行)
```python
@staticmethod
def _infer_track_type(material: MaterialPayload) -> str:
    ...
    if material_type in RuleTestService.NEW_TYPES:
        return "new_type"
    ...
```

#### 6. 添加 category 映射
**位置**: `_clone_segment_with_materials` 方法 (第 1228-1235 行)
```python
material_category_map = {
    ...
    "new_type": "new_materials",
}
```

#### 7. 添加 segment 构建逻辑 (可选)
**位置**: `_build_segment` 方法 (第 238-271 行)
```python
@staticmethod
def _build_segment(material: MaterialPayload, item_data: Dict[str, Any]):
    ...
    if material_type in RuleTestService.NEW_TYPES:
        return draft.NewSegment(...)
    ...
```

---

## 关键参数说明

### `Track_meta(segment_class, render_index, allow_modify)`

| 参数 | 说明 | 常用值 |
|------|------|--------|
| `segment_class` | Segment 类 | `NewSegment` |
| `render_index` | 渲染层级 | 主轨道: `0`<br>特效: `10000+`<br>文本: `15000+` |
| `allow_modify` | 是否可修改 | `True`: 可修改<br>`False`: 只读 |

### Material Category 命名规范

- 使用**复数**形式: `masks`, `transitions`, `effects`
- 与剪映 `draft_content.json` 中的 `materials` 字段对应
- 常见 category:
  - `videos`, `audios`, `texts`
  - `effects`, `video_effects`
  - `stickers`, `masks`, `transitions`

---

## 测试命令

```bash
# 1. 测试枚举
python -c "from pyJianYingDraft import TrackType; print(TrackType.new_type)"

# 2. 测试 Segment 创建
python -c "from pyJianYingDraft import NewSegment, trange; seg = NewSegment(...); print(seg.export_json())"

# 3. 测试服务端
curl -X POST http://localhost:8000/api/rule-test \
  -H "Content-Type: application/json" \
  -d @test_new_type.json
```

---

## 常见错误

### ❌ 错误 1: `ValueError: Invalid track type: new_type`
**原因**: `TrackType` 枚举中未定义
**修复**: 在 `pyJianYingDraft/track.py` 中添加枚举

### ❌ 错误 2: 素材被识别为 `video` 类型
**原因**: `_infer_track_type` 未处理新类型
**修复**: 添加类型推断逻辑

### ❌ 错误 3: 警告 "未找到专用模板,使用类型模板"
**原因**: `segment_templates_by_type` 中没有该类型的模板
**可能原因**:
1. `allow_modify=False` 导致 segments 未收集 (已修复)
2. 模板数据中没有该类型的轨道
**修复**: 检查 `raw_segments` 中是否包含该类型的轨道

### ❌ 错误 4: 草稿在剪映中打开失败
**原因**: JSON 结构不符合剪映格式
**修复**:
1. 检查 `export_json` 输出格式
2. 对比剪映导出的草稿文件
3. 确保必填字段完整

---

## 文件路径速查

| 修改内容 | 文件路径 | 行号 |
|---------|----------|------|
| TrackType 枚举 | `pyJianYingDraft/track.py` | 31-45 |
| 类型常量 | `pyJianYingDraftServer/app/services/rule_test_service.py` | 39-41 |
| 类型推断 | `pyJianYingDraftServer/app/services/rule_test_service.py` | 136-149 |
| Category 映射 | `pyJianYingDraftServer/app/services/rule_test_service.py` | 1228-1235 |
| Segment 构建 | `pyJianYingDraftServer/app/services/rule_test_service.py` | 238-271 |
| 模板导入 | `pyJianYingDraft/template_mode.py` | 215-222 |

---

## 调试技巧

### 1. 打印调试信息
在代码中添加 `print` 语句:
```python
print(f"[DEBUG] material_type={material_type}, inferred_type={inferred_type}")
```

### 2. 检查生成的 JSON
```python
import json
data = script.export_json()
with open("debug_output.json", "w", encoding="utf-8") as f:
    json.dump(data, f, ensure_ascii=False, indent=2)
```

### 3. 对比剪映草稿
```bash
# 手动在剪映中创建包含新类型的草稿
# 导出并对比 draft_content.json
diff manual_draft.json generated_draft.json
```

---

**快速参考版本** | 完整文档见: [如何添加新的轨道类型和素材类型.md](./如何添加新的轨道类型和素材类型.md)
