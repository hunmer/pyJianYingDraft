{
  "task": "事件日志从前端本地管理改为后端API管理",
  "date": "2025-10-31",
  "changes": [
    {
      "file": "pyJianYingDraftServer/app/services/event_log_service.py",
      "type": "新增",
      "description": "创建事件日志服务，在内存中保存最近1000条工作流执行事件日志"
    },
    {
      "file": "pyJianYingDraftServer/app/routers/coze.py",
      "type": "修改",
      "description": "添加事件日志API接口：GET /api/coze/event-logs（分页查询）、DELETE /api/coze/event-logs（清空日志）、GET /api/coze/event-logs/count（获取总数）"
    },
    {
      "file": "pyjianyingdraft-web/src/lib/api.ts",
      "type": "修改",
      "description": "在cozeApi中添加getEventLogs、clearEventLogs、getEventLogsCount方法"
    },
    {
      "file": "pyjianyingdraft-web/src/hooks/useCoZone.ts",
      "type": "修改",
      "description": "修改事件日志相关方法，从后端获取数据而不是本地状态管理"
    },
    {
      "file": "pyjianyingdraft-web/src/components/WorkflowEventLogsDialog.tsx",
      "type": "修改",
      "description": "重构为从后端加载数据，支持滚动到底部动态加载，每次加载200条记录"
    },
    {
      "file": "pyjianyingdraft-web/src/components/WorkflowPanel.tsx",
      "type": "修改",
      "description": "移除eventLogs prop依赖，简化事件日志按钮显示"
    },
    {
      "file": "pyJianYingDraftServer/app/routers/coze.py",
      "type": "修改",
      "description": "在流式执行工作流过程中集成事件日志记录，记录workflow_started/流式事件/workflow_error/workflow_exception/workflow_finished"
    },
    {
      "file": "pyJianYingDraftServer/app/services/coze_workflow_service.py",
      "type": "修改",
      "description": "在同步执行任务过程中集成事件日志记录，记录task_execute_started/task_execute_success/task_execute_failed/task_execute_exception"
    }
  ],
  "features": [
    "后端保存最后1000条事件日志",
    "前端首次加载200条日志",
    "滚动到底部自动加载更多（每次200条）",
    "支持按工作流ID和日志级别筛选",
    "支持清空所有事件日志",
    "持久化保存到JSON文件（pyJianYingDraftServer/data/event_logs.json）",
    "服务器重启后自动从文件恢复日志"
  ],
  "api": {
    "endpoints": [
      {
        "method": "GET",
        "path": "/api/coze/event-logs",
        "description": "获取事件日志列表（分页）",
        "params": {
          "limit": "返回数量限制（1-1000，默认200）",
          "offset": "偏移量（默认0）",
          "workflow_id": "按工作流ID筛选（可选）",
          "level": "按日志级别筛选（可选：info/warning/error/success）"
        },
        "response": {
          "success": true,
          "logs": "日志数组",
          "total": "总数",
          "limit": "本次限制",
          "offset": "本次偏移",
          "has_more": "是否还有更多"
        }
      },
      {
        "method": "DELETE",
        "path": "/api/coze/event-logs",
        "description": "清空所有事件日志",
        "response": {
          "success": true,
          "message": "事件日志已清空"
        }
      },
      {
        "method": "GET",
        "path": "/api/coze/event-logs/count",
        "description": "获取事件日志总数",
        "response": {
          "success": true,
          "count": "日志总数"
        }
      }
    ]
  },
  "notes": [
    "事件日志最多保存1000条，超过后自动溺出最早的日志",
    "日志持久化保存到 pyJianYingDraftServer/data/event_logs.json",
    "服务器重启后会自动从文件恢复日志",
    "前端不再本地维护事件日志状态",
    "流式执行和同步执行都已集成事件日志记录",
    "每次添加日志时都会自动保存到文件，使用线程锁保证线程安全"
  ],
  "event_types": {
    "workflow_started": "工作流开始执行（流式）",
    "workflow_finished": "工作流执行完成（流式）",
    "workflow_error": "工作流执行错误（流式）",
    "workflow_exception": "工作流执行异常（流式）",
    "task_execute_started": "任务开始执行（同步）",
    "task_execute_success": "任务执行成功（同步）",
    "task_execute_failed": "任务执行失败（同步）",
    "task_execute_exception": "任务执行异常（同步）",
    "stream_events": "流式执行过程中的各种事件（如Message、NodeStarted等）"
  ],
  "storage": {
    "file_path": "pyJianYingDraftServer/data/event_logs.json",
    "format": "JSON",
    "structure": {
      "logs": "日志数组，每个日志包含id/event/workflowId/workflowName/executeId/level/message/data/details/timestamp",
      "total": "日志总数",
      "last_updated": "最后更新时间"
    },
    "max_size": 1000,
    "encoding": "UTF-8",
    "thread_safe": true
  }
}
