# Coze å‰ªæ˜ è‰ç¨¿æ’ä»¶èŠ‚ç‚¹

åŸºäº `pyJianYingDraftServer` API çš„ Coze æ’ä»¶èŠ‚ç‚¹,ç”¨äºåœ¨ Coze å·¥ä½œæµä¸­å¤„ç†å‰ªæ˜ è‰ç¨¿æ•°æ®ã€‚

## ğŸ“¦ æ’ä»¶èŠ‚ç‚¹åˆ—è¡¨

### 1. è¯»å–é¢„è®¾èŠ‚ç‚¹ (readPreset.ts)

**åŠŸèƒ½**: æ ¡éªŒå¹¶è¿”å›å‰ªæ˜ è‰ç¨¿é¢„è®¾æ•°æ®

**è¾“å…¥å‚æ•°**:
- `preset_data` (å¿…éœ€): JSON å­—ç¬¦ä¸²,åŒ…å«å®Œæ•´çš„ full-request.json ä¿¡æ¯
- `api_base` (å¯é€‰): API æœåŠ¡å™¨åŸºç¡€åœ°å€,é»˜è®¤ `http://localhost:8000`

**è¾“å‡º**:
- `valid`: å¸ƒå°”å€¼,æ˜¯å¦é€šè¿‡æ ¡éªŒ
- `preset_data`: åŸå§‹æ•°æ®(æ ¡éªŒé€šè¿‡æ—¶è¿”å›)
- `api_base`: API åŸºç¡€åœ°å€
- `stats`: ç»Ÿè®¡ä¿¡æ¯(è§„åˆ™æ•°é‡ã€ç´ ææ•°é‡ã€è½¨é“æ•°é‡ç­‰)
- `message`: ç»“æœæ¶ˆæ¯
- `error`: é”™è¯¯ä¿¡æ¯(æ ¡éªŒå¤±è´¥æ—¶è¿”å›)

**æ•°æ®æ ¡éªŒé¡¹**:
- âœ… å¿…éœ€å­—æ®µæ£€æŸ¥: `ruleGroup`, `materials`, `testData`
- âœ… `ruleGroup` ç»“æ„: `id`, `title`, `rules` æ•°ç»„
- âœ… `materials` å¿…é¡»æ˜¯æ•°ç»„
- âœ… `testData` ç»“æ„: `tracks` å’Œ `items` æ•°ç»„
- âœ… `use_raw_segments` æ¨¡å¼æ ¡éªŒ
- âœ… `raw_segments` å’Œ `raw_materials` ç»“æ„æ ¡éªŒ
- âœ… ç”»å¸ƒé…ç½®æ ¡éªŒ (`draft_config`)

---

### 2. ä¿å­˜è‰ç¨¿èŠ‚ç‚¹ (importDraft.ts)

**åŠŸèƒ½**: è°ƒç”¨ API å°†é¢„è®¾æ•°æ®ä¿å­˜ä¸ºå‰ªæ˜ è‰ç¨¿

**è¾“å…¥å‚æ•°**:
- `preset_data` (å¿…éœ€): JSON å­—ç¬¦ä¸²,åŒ…å«å®Œæ•´çš„ full-request.json ä¿¡æ¯
- `draft_title` (å¯é€‰): è‡ªå®šä¹‰è‰ç¨¿æ ‡é¢˜,é»˜è®¤ä½¿ç”¨ `ruleGroup.title`
- `api_base` (å¯é€‰): API æœåŠ¡å™¨åŸºç¡€åœ°å€,é»˜è®¤ `http://localhost:8000`

**è¾“å‡º**:
- `success`: å¸ƒå°”å€¼,æ˜¯å¦æˆåŠŸä¿å­˜
- `draft_path`: ä¿å­˜çš„è‰ç¨¿è·¯å¾„
- `draft_name`: è‰ç¨¿åç§°
- `message`: ç»“æœæ¶ˆæ¯
- `api_response`: å®Œæ•´çš„ API å“åº”
- `error`: é”™è¯¯ä¿¡æ¯(å¤±è´¥æ—¶è¿”å›)

**è°ƒç”¨ API**: `POST /api/rules/test`

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### Coze å·¥ä½œæµé…ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·è¾“å…¥      â”‚
â”‚ (preset JSON)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¯»å–é¢„è®¾èŠ‚ç‚¹    â”‚  â† æ ¡éªŒæ•°æ®æ ¼å¼
â”‚ (readPreset)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€ valid=false â†’ è¿”å›é”™è¯¯
         â”‚
         â””â”€ valid=true
                  â”‚
                  â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ ä¿å­˜è‰ç¨¿èŠ‚ç‚¹    â”‚  â† è°ƒç”¨ API
         â”‚ (importDraft)   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â”œâ”€ success=false â†’ è¿”å›é”™è¯¯
                  â”‚
                  â””â”€ success=true
                           â”‚
                           â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  è¿”å›è‰ç¨¿è·¯å¾„   â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è¾“å…¥æ•°æ®ç¤ºä¾‹

å‚è€ƒ `coze-plugin/full-request.json` çš„å®Œæ•´ç»“æ„ã€‚å…³é”®å­—æ®µ:

```json
{
  "ruleGroup": {
    "id": "group_xxx",
    "title": "ç«–å±äººç‰©å›¾ç‰‡",
    "rules": [
      {
        "type": "image",
        "title": "å›¾ç‰‡",
        "material_ids": ["material_id_1"]
      }
    ]
  },
  "materials": [
    {
      "id": "material_id_1",
      "type": "photo",
      "path": "path/to/image.png"
    }
  ],
  "testData": {
    "tracks": [
      {
        "id": "1",
        "type": "video",
        "title": "è§†é¢‘"
      }
    ],
    "items": [
      {
        "type": "image",
        "data": {
          "track": "1",
          "start": 0,
          "duration": 5.616
        }
      }
    ]
  },
  "use_raw_segments": true,
  "raw_segments": [...],
  "raw_materials": [...],
  "segment_styles": {...},
  "draft_config": {
    "canvas_config": {
      "canvas_width": 1440,
      "canvas_height": 2560
    },
    "fps": 30
  }
}
```

---

## âš™ï¸ å‰ç½®è¦æ±‚

### 1. å¯åŠ¨ pyJianYingDraftServer

ç¡®ä¿ API æœåŠ¡å·²å¯åŠ¨:

```bash
cd pyJianYingDraftServer
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### 2. é…ç½®è‰ç¨¿æ ¹ç›®å½•

ç¼–è¾‘ `pyJianYingDraftServer/config.json`:

```json
{
  "PYJY_DRAFT_ROOT": "G:/jianyin5.9_drafts/JianyingPro Drafts/"
}
```

æˆ–é€šè¿‡ API è®¾ç½®:

```bash
curl -X POST "http://localhost:8000/api/draft/config/root" \
  -H "Content-Type: application/json" \
  -d '{"draft_root": "G:/jianyin5.9_drafts/JianyingPro Drafts/"}'
```

---

## ğŸ”§ å¼€å‘è¯´æ˜

### æ–‡ä»¶ç»“æ„

```
coze-plugin/
â”œâ”€â”€ demo.ts                  # æ¨¡æ¿æ–‡ä»¶
â”œâ”€â”€ readPreset.ts            # è¯»å–é¢„è®¾èŠ‚ç‚¹
â”œâ”€â”€ importDraft.ts           # ä¿å­˜è‰ç¨¿èŠ‚ç‚¹
â”œâ”€â”€ full-request.json        # å®Œæ•´è¯·æ±‚æ•°æ®ç¤ºä¾‹
â””â”€â”€ README.md                # æœ¬æ–‡æ¡£
```

### æ·»åŠ æ–°èŠ‚ç‚¹

1. å¤åˆ¶ `demo.ts` ä½œä¸ºæ¨¡æ¿
2. å®ç° `handler` å‡½æ•°
3. åœ¨ Coze å¹³å°é…ç½®è¾“å…¥/è¾“å‡ºå‚æ•°å…ƒæ•°æ®

### è°ƒè¯•æŠ€å·§

- ä½¿ç”¨ `logger.info()` å’Œ `logger.error()` è¾“å‡ºæ—¥å¿—
- åœ¨ Coze å·¥ä½œæµä¸­æŸ¥çœ‹èŠ‚ç‚¹æ‰§è¡Œæ—¥å¿—
- ä½¿ç”¨ Postman æµ‹è¯• API ç«¯ç‚¹

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [pyJianYingDraft README](../CLAUDE.md)
- [pyJianYingDraftServer API æ–‡æ¡£](../pyJianYingDraftServer/README.md)
- API äº¤äº’å¼æ–‡æ¡£: http://localhost:8000/docs

---

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ 1: æ— æ³•è¿æ¥åˆ° API æœåŠ¡å™¨

**é”™è¯¯**: `æ— æ³•è¿æ¥åˆ° API æœåŠ¡å™¨ (http://localhost:8000)`

**è§£å†³**:
1. ç¡®è®¤æœåŠ¡å·²å¯åŠ¨: `http://localhost:8000/health`
2. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
3. å¦‚æœåœ¨è¿œç¨‹æœåŠ¡å™¨,ä½¿ç”¨å®Œæ•´ URL (å¦‚ `http://192.168.1.100:8000`)

### é—®é¢˜ 2: è‰ç¨¿ä¿å­˜å¤±è´¥

**é”™è¯¯**: `API é”™è¯¯: æœªåœ¨ config.json æˆ–ç¯å¢ƒå˜é‡ PYJY_DRAFT_ROOT ä¸­é…ç½®è‰ç¨¿ä¿å­˜ç›®å½•`

**è§£å†³**:
1. é…ç½®è‰ç¨¿æ ¹ç›®å½• (å‚è€ƒä¸Šæ–¹é…ç½®è¯´æ˜)
2. ç¡®è®¤ç›®å½•å­˜åœ¨ä¸”æœ‰å†™å…¥æƒé™

### é—®é¢˜ 3: æ•°æ®æ ¡éªŒå¤±è´¥

**é”™è¯¯**: `ç¼ºå°‘å¿…éœ€å­—æ®µ: ruleGroup, materials, testData`

**è§£å†³**:
1. æ£€æŸ¥è¾“å…¥æ•°æ®æ ¼å¼æ˜¯å¦ç¬¦åˆ `full-request.json` ç»“æ„
2. ç¡®ä¿æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½å·²æä¾›
3. å‚è€ƒæœ¬æ–‡æ¡£ä¸­çš„è¾“å…¥æ•°æ®ç¤ºä¾‹

---
